"use strict";Object.merge_es_private=function(e,...t){for(const n of t){if("object"!=typeof e||typeof e!=typeof n){e=n;continue}let t=Array.isArray(n);(Array.isArray(e)||t)&&(e=t?[]:{});for(const t in n){let s=void 0,i=!1;(s=n.__lookupGetter__(t))&&(e.__defineGetter__(t,s),i=!0),(s=n.__lookupSetter__(t))&&(e.__defineSetter__(t,s),i=!0),i||(s=n[t],e[t]="object"!=typeof s?s:Object.merge_es_private(e[t]||{},s))}}return e},window.$es=window.$es||{autoIncrement:0,elements:{},componnents:{},renderStack:[],define:function(e){if(this.componnents[e.id])throw`Component[${e.id}] aready exists!`;Object.keys(e).forEach(function(t){"object"==typeof e[t]&&Object.freeze(e[t])}),this.componnents[e.id]=Object.freeze(e)},getComponentById:function(e){return this.componnents[e]},getCurrentRenderer(){return this.renderStack.length?this.renderStack[this.renderStack.length-1]:void 0},em(e){if("number"==typeof e)return this.elements[e];for("string"==typeof e&&(e=document.getElementById(e));e;){if(e.$instance)return e;e=e.parentNode}},it(e){let t=this.em(e);return t?t.$instance:void 0},on(e){let t=this.em(e.srcElement);if(!t)return;let n=t.$instance,s="on"+e.type,i=n.events[s],o=!!i&&i.bind(n,e).call(),r=t.$extend.events[s];return"function"==typeof r?o|=r.bind(n,e).call():r&&t.$parent&&(i=t.$parent.$instance.events[r])&&(o|=i.bind(t.$parent.$instance,e).call()),o}},$es.EsProxy=function(e,t){return new Proxy(e,{extend:t,watchers:{},get:function(e,t,n){let s=this.extend[t];if(s)return s.get.bind(s.scope).call();let i=$es.getCurrentRenderer();return i&&(this.watchers[t]||(this.watchers[t]=new Set)).add(i.$unique),Reflect.get(e,t,n)},set:function(e,t,n,s){let i=this.extend[t];if(i)return i.set.bind(i.scope,n).call(),!0;let o=Reflect.set(e,t,n,s),r=this.watchers[t];if(r)for(const e of r){let s=$es.em(e);s?s.esUpdate(t,n)||s.esRender():r.delete(e)}return o}})};class ESUseElement extends HTMLElement{static get observedAttributes(){return["component"]}constructor(){super(),this.$parent=void 0,this.$children=[],this.$connected=!1,this.$unique=$es.autoIncrement++,this.esReset()}connectedCallback(){let e=[`$${this.$unique}`],t=this.parentNode;for(;t;)t.$instance&&(e.push(`$${t.$unique}`),this.$parent||(this.$parent=t,this.$parent.$children.push(this))),t=t.parentNode;$es.elements[this.$unique]=this,this.$path=e.reverse(),this.$connected=!0,setTimeout(()=>{this.esReload()},0)}disconnectedCallback(){delete $es.elements[this.$unique],this.$connected=!1,this.$instance&&this.$instance.isMounted&&this.$instance.destroyed&&this.$instance.destroyed.bind(this.$instance,this).call(),this.$parent&&(this.$parent.$children.splice(this.$parent.$children.indexOf(this),1),this.$parent=void 0),this.$component=void 0,this.$extend=void 0,this.$instance=void 0}adoptedCallback(){}attributeChangedCallback(e,t,n){this.$connected&&t!=n&&"component;".indexOf(e)>=0&&this.esReload()}calComponentId(){return this.getAttribute("component")}getComponentById(e){if(e){if("#"==e[0])return{id:e,template:document.getElementById(e.substring(1)).innerHTML};{let t=$es.getComponentById(e);if(!t)throw`Component[${e}] not found!`;return t}}for(const e of this.children){if("template"!=e.tagName.toLocaleLowerCase())continue;let t=e.getAttribute("slot");if(!t||"default"==t)return{id:void 0,template:e.innerHTML}}return{id:void 0,template:""}}esReset(){this.$component=eval("({id:0, data: {}, styles: {default:{}}, slots: {}, events: {}, accelerator: {}})"),this.$extend=eval("({data: {}, styles: {}, slots: {}, events: {}, alias: {}})"),this.$instance&&(this.$instance.$element=void 0),this.$instance={$element:this,isMounted:!1,applyStyles:function(){this.styles&&this.styles.default&&this.$element.children[0]&&(this.$element.children[0].style=Object.keys(this.styles.default).map(e=>`${e}:${this.styles.default[e]}`).join(";"))},render:function(){this.$element.innerHTML=eval("(`"+this.template+"`)")}}}esReshape(compId){this.$instance&&this.$instance.isMounted&&this.$instance.destroyed&&this.$instance.destroyed.bind(this.$instance,this).call(),this.esReset(),Object.merge_es_private(this.$component,this.getComponentById(compId));let slots={},extend=void 0;for(const e of this.children){let tagName=e.tagName.toLocaleLowerCase();if("template"==tagName){let t=e.getAttribute("slot");if(!t||"default"==t)continue;slots[t]=e.innerHTML}else{if("script"!=tagName||void 0!=extend)throw"Only template and script can be placed in <es-use> block!";if(extend=eval(`(${e.innerHTML})`),!extend)throw"Illegal script found!";Object.merge_es_private(this.$extend,extend)}}Object.freeze(this.$extend),Object.merge_es_private(this.$instance,this.$component,{data:this.$extend.data,styles:this.$extend.styles,slots:slots});{let obs=this.$extend.alias;for(const key in obs){let v=void 0,ms=void 0;if(obs.__lookupGetter__(key)||obs.__lookupSetter__(key))throw"Defines seter | getter inside alias is not allowed!";if("string"!=typeof(v=obs[key]))throw"Only string is allowed to define inside alias!";if(!(ms=/^((?:[$_a-z][$_0-9a-z]*\.)*)([$_a-z][$_0-9a-z]*)/i.exec(v)))throw`Illegal expression '${v}'!`;let scope=this.$parent?this.$parent.$instance:void 0,valuePath=v;ms[1]?ms[1].startsWith("data.")?valuePath=`this.${v}`:ms[1].startsWith("this.")||(scope=window):valuePath=`this.data.${v}`,obs[key]={scope:scope,get:eval(`(function(){return ${valuePath}})`),set:eval(`(function(val){${valuePath}=val;})`)}}this.$instance.data=$es.EsProxy(this.$instance.data,this.$extend.alias||{})}return this.$instance.created&&this.$instance.created.bind(this.$instance,this).call(),!0}esReload(e=!1){let t=this.calComponentId();if(t!=this.$component.id)this.esReshape(t);else if(!e)return;if(this.esRender(),!this.$instance.isMounted){this.$instance.isMounted=!0;let e=this.children[0];for(const t in this.$extend.events)e.setAttribute(t,"$es.on(event)");this.$instance.mounted&&this.$instance.mounted.bind(this.$instance,this).call()}}esUpdate(e,t){let n=this.$instance.accelerator[e];if(n){$es.renderStack.push(this);try{return n.bind(this.$instance,t).call()}finally{$es.renderStack.pop()!=this&&console.warn("Es internal error!")}}return!1}esApplyStyle(e){this.$instance.applyStyles.bind(this.$instance,e||"default").call()}esRender(){$es.renderStack.push(this);try{this.$instance.render.bind(this.$instance).call(),this.$instance.applyStyles.bind(this.$instance).call()}finally{$es.renderStack.pop()!=this&&console.warn("Es internal error!")}}}customElements.define("es-use",ESUseElement),$es.router={uriBase:"",urlPrefix:"",routes:{},stack:[],fromPath:function(path){if("/"==path)return this.routes.$;let uri=path.split("#")[0];if(uri=uri.split("?")[0],!/^[0-9a-z_/]+[0-9a-z_]$/i.test(uri))return;let objPath=`this.routes${"/"==uri[0]?"":"."}`+uri.split("/").join(".")+".$";try{return eval(`(${objPath})`)}catch(e){return}},define:function(component){if("/"==component.id){if(this.routes.$)throw`Component[${component.id}] aready exists!`;return void(this.routes.$=component)}if(!/^\/[0-9a-z_/]+[0-9a-z_]$/i.test(component.id))throw`Illegal path [${component.id}]!`;let names=component.id.substring(1).split("/"),objSrc="{"+names.join(":{")+":{}"+"}".repeat(names.length);Object.merge_es_private(this.routes,eval(`(${objSrc})`));let objPath="this.routes."+names.join("."),objNode=eval(`(${objPath})`);if(objNode.$)throw`Component[${component.id}] aready exists!`;objNode.$=component},popstateChanged:function(){let e=location.href.substring($es.router.urlPrefix.length);if(!this.stack.length||this.stack[this.stack.length-1].$component.id==e)return;let t=this.stack.length;for(;t;)this.stack[--t].esReload()},goto:function(e){if(e.startsWith("http:")||e.startsWith("https:")||e.startsWith("file:"))location.href=e;else{let t=location.href.substring($es.router.urlPrefix.length);if("/"!=e[0]){let n=t.split("#")[0].split("?")[0].split("/");n.length&&n.splice(n.length-1),e="/"+n.join("/")+e}if(t==e)return;history.pushState({key:Date.now().toFixed(3)},"",$es.router.urlPrefix+e),this.popstateChanged()}}},$es.router.urlPrefix=`${location.protocol}//${"file:"==location.protocol?location.pathname:location.host+$es.router.uriBase}#`;class EsSlotElement extends ESUseElement{constructor(){super()}connectedCallback(){super.connectedCallback(),$es.router.stack.length||window.addEventListener("popstate",$es.router.popstateChanged.bind($es.router));let e=0,t=this.$parent;for(;t;)t instanceof EsSlotElement&&e++,t=t.$parent;this.$depth=e,e<$es.router.stack.length?$es.router.stack.splice(e):$es.router.stack.push(this)}disconnectedCallback(){super.disconnectedCallback();let e=$es.router.stack.indexOf(this);e>=0&&$es.router.stack.splice(e),$es.router.stack.length||window.removeEventListener("popstate",$es.router.popstateChanged.bind($es.router))}isTop(){return $es.router.stack[0]==this}calComponentId(){let e=this.getAttribute("component");if(this.isTop())e="/";else{if(e&&"/"!=e[0])throw`Illegal uri[${e}]!`;let t=location.hash;if(t.length<=$es.router.uriBase.length)return;t=t.substring($es.router.uriBase.length+1),e&&e.startsWith(t)&&(t=e);let n=(t=t.substring(1)).split("#")[0].split("?")[0].split("/");if(n.length<this.$depth)throw`Illegal uri[${t}]!`;e="/"+n.slice(0,this.$depth).join("/")}return e}getComponentById(e){let t=$es.router.fromPath(e);if(!t)throw`Component[${e}] not found!`;return t}esReshape(e){this.innerHTML="",super.esReshape(e)&&(history.replaceState({key:Date.now().toFixed(3)},"",$es.router.urlPrefix+e),this.setAttribute("component",e))}}customElements.define("es-slot",EsSlotElement)